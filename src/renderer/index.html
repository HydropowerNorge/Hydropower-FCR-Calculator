<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; worker-src 'self'; style-src 'self' 'unsafe-inline'">
  <title>Hydropower</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="brand-lockup">
          <img class="brand-logo" src="assets/hydropower-logo.png" alt="Hydropower logo">
          <div class="brand-copy">
            <p class="brand-eyebrow">Hydropower Energy Platform</p>
            <h1>Hydropower</h1>
            <p class="subtitle">Inntektsestimator for batteri</p>
          </div>
        </div>
      </div>

      <nav class="tab-nav" role="tablist" aria-label="Analysemoduler">
        <button
          id="tab-fcr"
          class="tab-btn active"
          data-tab="fcr"
          role="tab"
          aria-controls="fcrContent"
          aria-selected="true"
          data-hero-title="FCR-N analyse"
          data-hero-description="Bruk historiske NO1-data til å estimere batteriinntekter med tydelige KPI-er og eksportklare rapporter."
        >FCR-N</button>
        <button
          id="tab-afrr"
          class="tab-btn"
          data-tab="afrr"
          role="tab"
          aria-controls="afrrContent"
          aria-selected="false"
          data-hero-title="aFRR"
          data-hero-description="Planlagt modul for automatisk frekvensgjenoppretting med bud- og aktiveringsanalyse."
        >aFRR</button>
        <button
          id="tab-nodes"
          class="tab-btn"
          data-tab="nodes"
          role="tab"
          aria-controls="nodesContent"
          aria-selected="false"
          data-hero-title="Nodes"
          data-hero-description="Planlagt nodenivå-visning for lokasjon, begrensninger og ytelsesoversikt."
        >Nodes</button>
        <button
          id="tab-combined"
          class="tab-btn"
          data-tab="combined"
          role="tab"
          aria-controls="combinedContent"
          aria-selected="false"
          data-hero-title="Kombinert"
          data-hero-description="Planlagt samlekjøring av markeder for helhetlig verdiestimat og sammenligning."
        >Kombinert</button>
      </nav>

      <section class="config-section">
        <h2>Batterikonfigurasjon</h2>

        <div class="input-group">
          <label for="powerMw">Effektkapasitet (MW) <button class="info-btn" data-help="powerMw">?</button></label>
          <input type="number" id="powerMw" value="1.0" min="0.1" max="100" step="0.1">
          <div class="help-text" id="help-powerMw">Hvor mye strøm batteriet kan levere på én gang. Eksempel: 1 MW = nok strøm til 500-1000 boliger samtidig.</div>
        </div>

        <div class="input-group">
          <label for="capacityMwh">Energikapasitet (MWh) <button class="info-btn" data-help="capacityMwh">?</button></label>
          <input type="number" id="capacityMwh" value="2.0" min="0.1" max="500" step="0.1">
          <div class="help-text" id="help-capacityMwh">Hvor mye strøm batteriet kan lagre totalt. Eksempel: 2 MWh = nok til å drive 1 MW i 2 timer.</div>
        </div>

        <div class="input-group">
          <label for="efficiency">Virkningsgrad: <span id="efficiencyValue">90</span>% <button class="info-btn" data-help="efficiency">?</button></label>
          <input type="range" id="efficiency" value="90" min="70" max="99">
          <div class="help-text" id="help-efficiency">Hvor mye strøm du får tilbake når du lader og bruker batteriet. 90% betyr at 10% går tapt som varme.</div>
        </div>

        <div class="input-group">
          <label for="socMin">Minimum SOC: <span id="socMinValue">20</span>% <button class="info-btn" data-help="socMin">?</button></label>
          <input type="range" id="socMin" value="20" min="0" max="50">
          <div class="help-text" id="help-socMin">Laveste tillatte ladenivå. 20% betyr at batteriet aldri tømmes helt - det forlenger levetiden.</div>
        </div>

        <div class="input-group">
          <label for="socMax">Maksimum SOC: <span id="socMaxValue">80</span>% <button class="info-btn" data-help="socMax">?</button></label>
          <input type="range" id="socMax" value="80" min="50" max="100">
          <div class="help-text" id="help-socMax">Høyeste tillatte ladenivå. 80% betyr at batteriet aldri lades helt fullt - det forlenger levetiden.</div>
        </div>
      </section>

      <!-- FCR-N data config -->
      <div data-tab-config="fcr">
        <section class="config-section">
          <h2>Datavalg</h2>

          <div class="input-group">
            <label for="year">År <button class="info-btn" data-help="year">?</button></label>
            <select id="year"></select>
            <div class="help-text" id="help-year">Hvilket år prisdata skal hentes fra. Prisene varierer fra år til år.</div>
          </div>
        </section>

        <input type="hidden" id="simHours" value="8760">
        <input type="hidden" name="profile" value="medium">
        <input type="hidden" id="seed" value="42">

        <button id="calculateBtn" class="btn btn-primary">Beregn inntekt</button>
      </div>

      <!-- Arbitrage data config -->
      <div data-tab-config="arbitrage" style="display: none;">
        <section class="config-section">
          <h2>Spotprisdata</h2>

          <div class="input-group">
            <label for="spotPeriod">Periode</label>
            <select id="spotPeriod">
              <option value="3">Siste 3 måneder</option>
              <option value="6">Siste 6 måneder</option>
            </select>
          </div>

          <p id="spotFileStatus" class="info-text" style="margin-top: 4px;"></p>
        </section>

        <button id="calculateArbitrageBtn" class="btn btn-primary">Beregn arbitrasje</button>
      </div>

      <div data-tab-config="afrr" style="display: none;">
        <section class="config-section config-section-compact">
          <h2>aFRR</h2>
          <p class="info-text">Denne modulen er under utvikling. Her kommer reserveprodukt, aktiveringslogikk og resultatanalyse.</p>
        </section>
        <button class="btn btn-secondary" type="button" disabled>Kommer snart</button>
      </div>

      <div data-tab-config="nodes" style="display: none;">
        <section class="config-section config-section-compact">
          <h2>Nodes</h2>
          <p class="info-text">Denne modulen er under utvikling. Her kommer nodevalg, nettflyt og begrensningsanalyse.</p>
        </section>
        <button class="btn btn-secondary" type="button" disabled>Kommer snart</button>
      </div>

      <div data-tab-config="combined" style="display: none;">
        <section class="config-section config-section-compact">
          <h2>Kombinert</h2>
          <p class="info-text">Denne modulen er under utvikling. Her kommer kombinert analyse på tvers av markedene.</p>
        </section>
        <button class="btn btn-secondary" type="button" disabled>Kommer snart</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <section class="hero-banner">
        <div class="hero-content">
          <p class="hero-kicker">Hydropower</p>
        </div>
      </section>

      <!-- FCR-N Tab Content -->
      <div id="fcrContent" class="tab-content active" data-tab-panel="fcr" role="tabpanel" aria-labelledby="tab-fcr">
      <div id="loadingState" class="loading-state">
        <p>Laster prisdata...</p>
      </div>

      <div id="resultsContainer" style="display: none;">
        <!-- Status message -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Metrics -->
        <div class="metrics-row">
          <div class="metric-card">
            <span class="metric-value" id="totalRevenue">-</span>
            <span class="metric-label">Total inntekt <button class="info-btn" data-help="totalRevenue">?</button></span>
            <div class="help-text" id="help-totalRevenue">Summen batteriet tjener på et helt år ved å delta i frekvensmarkedet (FCR-N).</div>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="availableHours">-</span>
            <span class="metric-label">Tilgjengelige timer <button class="info-btn" data-help="availableHours">?</button></span>
            <div class="help-text" id="help-availableHours">Antall timer batteriet kan levere tjenesten. Noen timer er utilgjengelige fordi batteriet er for fullt eller for tomt.</div>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="availability">-</span>
            <span class="metric-label">Tilgjengelighet <button class="info-btn" data-help="availability">?</button></span>
            <div class="help-text" id="help-availability">Prosent av tiden batteriet kan delta i markedet. 95% betyr at det fungerer 95% av tiden.</div>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="avgPrice">-</span>
            <span class="metric-label">Snittpris <button class="info-btn" data-help="avgPrice">?</button></span>
            <div class="help-text" id="help-avgPrice">Gjennomsnittlig pris per MW per time i markedet dette året.</div>
          </div>
        </div>

        <p id="annualizedNote" class="annualized-note" style="display: none;"></p>

        <!-- Charts -->
        <section class="chart-section">
          <h2>Månedlig inntekt <button class="info-btn" data-help="monthlyChart">?</button></h2>
          <div class="help-text" id="help-monthlyChart">Viser hvor mye batteriet tjener hver måned. Prisene er ofte høyere om vinteren.</div>
          <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
          </div>
        </section>

        <section class="chart-section">
          <h2>Prisfordeling <button class="info-btn" data-help="priceChart">?</button></h2>
          <div class="help-text" id="help-priceChart">Viser hvor ofte ulike prisnivåer forekommer. Høye søyler = vanlige priser.</div>
          <div class="chart-container">
            <canvas id="priceChart"></canvas>
          </div>
        </section>

        <section id="socSection" class="chart-section" style="display: none;">
          <h2>SOC-utvikling <button class="info-btn" data-help="socChart">?</button></h2>
          <div class="help-text" id="help-socChart">Viser hvordan batteriets ladenivå endrer seg gjennom året. De røde stiplede linjene viser grensene dine.</div>
          <div class="chart-container chart-container-wide">
            <canvas id="socChart"></canvas>
          </div>
        </section>

        <section id="freqSection" class="chart-section" style="display: none;">
          <h2>Frekvensfordeling <button class="info-btn" data-help="freqChart">?</button></h2>
          <div class="help-text" id="help-freqChart">Viser hvor ofte strømnettet har ulike frekvenser. Grønne søyler = normalt (49.9-50.1 Hz), røde = unormalt.</div>
          <div class="chart-container">
            <canvas id="freqChart"></canvas>
          </div>
        </section>

        <!-- Export -->
        <section class="export-section">
          <button id="exportPdfBtn" class="btn btn-accent">Eksporter PDF</button>
          <button id="exportBtn" class="btn btn-secondary">Eksporter CSV</button>
          <button id="exportXlsxBtn" class="btn btn-secondary">Eksporter Excel</button>
        </section>

        <!-- Summary Table -->
        <section class="summary-section">
          <h2>Månedlig oppsummering</h2>
          <div class="table-container">
            <table id="summaryTable">
              <thead>
                <tr>
                  <th>Måned</th>
                  <th>Inntekt (EUR)</th>
                  <th>Timer</th>
                  <th>Snittpris (EUR/MW)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
      </div><!-- /fcrContent -->

      <!-- Arbitrage Tab Content -->
      <div id="arbitrageContent" class="tab-content" data-tab-panel="arbitrage" role="tabpanel">
        <div id="arbStatusMessage" class="status-message"></div>

        <!-- Metrics -->
        <div class="metrics-row">
          <div class="metric-card">
            <span class="metric-value" id="arbTotalRevenue">-</span>
            <span class="metric-label">Total inntekt</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="arbAvgDaily">-</span>
            <span class="metric-label">Snitt per dag</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="arbCycles">-</span>
            <span class="metric-label">Sykluser</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="arbDuration">-</span>
            <span class="metric-label">Varighet (timer)</span>
          </div>
        </div>

        <!-- Charts -->
        <section class="chart-section">
          <h2>Månedlig inntekt</h2>
          <div class="chart-container">
            <canvas id="arbMonthlyChart"></canvas>
          </div>
        </section>

        <section class="chart-section">
          <h2>Daglig profitt</h2>
          <div class="chart-container">
            <canvas id="arbDailyChart"></canvas>
          </div>
        </section>

        <section class="chart-section">
          <h2>Typisk dagsprofil</h2>
          <div class="chart-container">
            <canvas id="arbProfileChart"></canvas>
          </div>
        </section>

        <section class="chart-section">
          <h2>Kumulativ inntekt</h2>
          <div class="chart-container">
            <canvas id="arbCumulativeChart"></canvas>
          </div>
        </section>

        <!-- Export -->
        <section class="export-section">
          <button id="arbExportPdfBtn" class="btn btn-accent">Eksporter PDF</button>
          <button id="arbExportCsvBtn" class="btn btn-secondary">Eksporter CSV</button>
          <button id="arbExportXlsxBtn" class="btn btn-secondary">Eksporter Excel</button>
        </section>

        <!-- Summary Table -->
        <section class="summary-section">
          <h2>Månedlig oppsummering</h2>
          <div class="table-container">
            <table id="arbSummaryTable">
              <thead>
                <tr>
                  <th>Måned</th>
                  <th>Inntekt (EUR)</th>
                  <th>Dager</th>
                  <th>Snitt/dag (EUR)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div><!-- /arbitrageContent -->

      <div id="afrrContent" class="tab-content" data-tab-panel="afrr" role="tabpanel" aria-labelledby="tab-afrr">
        <section class="module-panel">
          <p class="module-pill">Planlagt modul</p>
          <h3>aFRR</h3>
          <p class="module-intro">Vi bygger en modul for å modellere bud, aktiveringer og effektiv leveranse i aFRR-markedet.</p>
          <div class="module-grid">
            <article class="module-card">
              <h4>Markedsvalg</h4>
              <p>Produkt, kapasitet og tidsoppløsning konfigureres per kjøring.</p>
            </article>
            <article class="module-card">
              <h4>Aktiveringsspor</h4>
              <p>Viser forventet aktiveringsgrad, energiutslag og tilgjengelighet.</p>
            </article>
            <article class="module-card">
              <h4>Rapporter</h4>
              <p>Samme eksportflyt som dagens moduler med tabeller og KPI-er.</p>
            </article>
          </div>
        </section>
      </div>

      <div id="nodesContent" class="tab-content" data-tab-panel="nodes" role="tabpanel" aria-labelledby="tab-nodes">
        <section class="module-panel">
          <p class="module-pill">Planlagt modul</p>
          <h3>Nodes</h3>
          <p class="module-intro">Her kommer en nodebasert visning for lokasjon, kapasitet og nettbegrensninger i samme arbeidsflate.</p>
          <div class="module-grid">
            <article class="module-card">
              <h4>Nodeliste</h4>
              <p>Rask filtrering på geografi, kapasitet og tekniske begrensninger.</p>
            </article>
            <article class="module-card">
              <h4>Driftsvindu</h4>
              <p>Oversikt over når anlegget er optimalt for frekvens og spot.</p>
            </article>
            <article class="module-card">
              <h4>Sammenligning</h4>
              <p>Lik visning for flere noder så du kan prioritere investeringer.</p>
            </article>
          </div>
        </section>
      </div>

      <div id="combinedContent" class="tab-content" data-tab-panel="combined" role="tabpanel" aria-labelledby="tab-combined">
        <section class="module-panel">
          <p class="module-pill">Planlagt modul</p>
          <h3>Kombinert</h3>
          <p class="module-intro">Denne fanen samler FCR-N, arbitrasje og kommende markeder i ett scenario med felles resultater.</p>
          <div class="module-grid">
            <article class="module-card">
              <h4>Scenariokjøring</h4>
              <p>Kjør markeder side om side uten å endre grunnkonfigurasjon.</p>
            </article>
            <article class="module-card">
              <h4>Prioriteringsregler</h4>
              <p>Definer hvilke markeder som får kapasitet ved konflikt.</p>
            </article>
            <article class="module-card">
              <h4>Samlet verdi</h4>
              <p>En konsolidert KPI-visning med eksport for ledelse og drift.</p>
            </article>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script src="../../node_modules/chart.js/dist/chart.umd.js"></script>
  <script src="../../node_modules/papaparse/papaparse.min.js"></script>
  <script src="calculator.js"></script>
  <script src="frequency.js"></script>
  <script src="arbitrage.js"></script>
  <script src="arbitrage-ui.js"></script>
  <script src="app.js"></script>
</body>
</html>
