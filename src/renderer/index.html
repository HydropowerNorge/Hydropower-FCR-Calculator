<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; worker-src 'self' blob:; style-src 'self' 'unsafe-inline'; connect-src 'self' ws: wss:">
  <title>Hydropower</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="brand-lockup">
          <img class="brand-logo" src="assets/hydropower-logo.png" alt="Hydropower logo">
          <div class="brand-copy">
            <p class="brand-eyebrow">Hydropower Energy Platform</p>
            <h1>Hydropower</h1>
          </div>
        </div>
      </div>

      <nav class="tab-nav" role="tablist" aria-label="Analysemoduler">
        <button
          id="tab-yearlyCombined"
          class="tab-btn tab-btn-wide active"
          data-tab="yearlyCombined"
          role="tab"
          aria-controls="yearlyCombinedContent"
          aria-selected="true"
          data-hero-title="Årskalkyle"
          data-hero-description="Kombinerer FCR-N, aFRR og Nodes i én årlig inntektskalkyle med samme metoder som i hver enkelt modul."
        >Årskalkyle</button>
        <button
          id="tab-fcr"
          class="tab-btn"
          data-tab="fcr"
          role="tab"
          aria-controls="fcrContent"
          aria-selected="false"
          data-hero-title="FCR-N analyse"
          data-hero-description="Bruk historiske NO1-data til å estimere batteriinntekter med tydelige KPI-er og eksportklare rapporter."
        >FCR-N</button>
        <button
          id="tab-afrr"
          class="tab-btn"
          data-tab="afrr"
          role="tab"
          aria-controls="afrrContent"
          aria-selected="false"
          data-hero-title="aFRR"
          data-hero-description="Årlig aFRR down-simulering for sol med kapasitetsbetaling, aktivering og curtailmentkost."
        >aFRR</button>
        <button
          id="tab-nodes"
          class="tab-btn"
          data-tab="nodes"
          role="tab"
          aria-controls="nodesContent"
          aria-selected="false"
          data-hero-title="Nodes"
          data-hero-description="Beregn årlig inntekt fra nodetendere basert på reservasjonspris, mengde og tidsplan."
        >Nodes</button>
        <button
          id="tab-combined"
          class="tab-btn"
          data-tab="combined"
          role="tab"
          aria-controls="combinedContent"
          aria-selected="false"
          data-hero-title="Forklaring"
          data-hero-description="Viser hvorfor batteriet må velge markedet med best verdi per time, og hvorfor FCR-N blir lavere i kombinert case."
        >Forklaring</button>
      </nav>

      <section id="batteryConfigSection" class="config-section collapsible">
        <button class="collapsible-toggle" type="button"><h2>Batterikonfigurasjon</h2></button>
        <div class="collapsible-body">
          <div class="input-group">
            <label for="powerMw">Effektkapasitet (MW) <button class="info-btn" data-help="powerMw">?</button></label>
            <input type="number" id="powerMw" value="1.0" min="0.1" max="100" step="0.1">
            <div class="help-text" id="help-powerMw">Hvor mye strøm batteriet kan levere på én gang. Eksempel: 1 MW = nok strøm til 500-1000 boliger samtidig.</div>
          </div>

          <div class="input-group">
            <label for="capacityMwh">Energikapasitet (MWh) <button class="info-btn" data-help="capacityMwh">?</button></label>
            <input type="number" id="capacityMwh" value="2.0" min="0.1" max="500" step="0.1">
            <div class="help-text" id="help-capacityMwh">Hvor mye strøm batteriet kan lagre totalt. Eksempel: 2 MWh = nok til å drive 1 MW i 2 timer.</div>
          </div>

          <div class="input-group">
            <label for="efficiency">Virkningsgrad: <span id="efficiencyValue">90</span>% <button class="info-btn" data-help="efficiency">?</button></label>
            <input type="range" id="efficiency" value="90" min="70" max="99">
            <div class="help-text" id="help-efficiency">Hvor mye strøm du får tilbake når du lader og bruker batteriet. 90% betyr at 10% går tapt som varme.</div>
          </div>

          <div class="input-group">
            <label for="socMin">Minimum SOC: <span id="socMinValue">20</span>% <button class="info-btn" data-help="socMin">?</button></label>
            <input type="range" id="socMin" value="20" min="0" max="50">
            <div class="help-text" id="help-socMin">Laveste tillatte ladenivå. 20% betyr at batteriet aldri tømmes helt - det forlenger levetiden.</div>
          </div>

          <div class="input-group">
            <label for="socMax">Maksimum SOC: <span id="socMaxValue">80</span>% <button class="info-btn" data-help="socMax">?</button></label>
            <input type="range" id="socMax" value="80" min="50" max="100">
            <div class="help-text" id="help-socMax">Høyeste tillatte ladenivå. 80% betyr at batteriet aldri lades helt fullt - det forlenger levetiden.</div>
          </div>
        </div>
      </section>

      <section id="solarConfigSection" class="config-section collapsible" style="display: none;">
        <button class="collapsible-toggle" type="button"><h2>Solkonfigurasjon</h2></button>
        <div class="collapsible-body">
          <div id="solarConfigVisual">
            <div class="input-group">
              <label for="solarMwp">Installert effekt (MWp): <span id="solarMwpValue">9</span></label>
              <input type="range" id="solarMwp" value="9" min="1" max="20" step="0.5" disabled aria-disabled="true">
              <div class="help-text">Låst verdi for visning.</div>
            </div>
            <div class="input-group">
              <label for="solarOrientation">Orientering</label>
              <select id="solarOrientation" disabled aria-disabled="true">
                <option selected>Øst/Vest</option>
              </select>
            </div>
            <div class="input-group">
              <label for="solarTilt">Panelvinkel: <span id="solarTiltValue">20</span>°</label>
              <input type="range" id="solarTilt" value="20" min="0" max="45" step="1" disabled aria-disabled="true">
            </div>
            <div class="input-group">
              <label for="solarZone">Prisområde</label>
              <select id="solarZone" disabled aria-disabled="true">
                <option selected>NO1</option>
              </select>
            </div>
            <div class="input-group">
              <label for="solarProfile">Produksjonsprofil</label>
              <select id="solarProfile" disabled aria-disabled="true">
                <option selected>Historisk profil (låst)</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <section id="infrastructureConfigSection" class="config-section collapsible" style="display: none;">
        <button class="collapsible-toggle" type="button"><h2>Infrastruktur</h2></button>
        <div class="collapsible-body">
          <div class="input-group">
            <label for="infraNode">Knutepunkt</label>
            <select id="infraNode" disabled aria-disabled="true">
              <option selected>NO1 - Transformatorstasjon A</option>
            </select>
          </div>
          <div class="input-group">
            <label for="infraConnectionMw">Nettilknytning: <span id="infraConnectionMwValue">12</span> MW</label>
            <input type="range" id="infraConnectionMw" value="12" min="5" max="20" step="0.5" disabled aria-disabled="true">
          </div>
          <div class="input-group">
            <label for="infraVoltage">Spenningsnivå</label>
            <select id="infraVoltage" disabled aria-disabled="true">
              <option selected>22 kV</option>
            </select>
          </div>
          <div class="input-group">
            <label for="infraRedundancy">Redundans</label>
            <select id="infraRedundancy" disabled aria-disabled="true">
              <option selected>N-1</option>
            </select>
          </div>
          <div class="input-group">
            <label for="infraAvailability">Teknisk tilgjengelighet: <span id="infraAvailabilityValue">99</span>%</label>
            <input type="range" id="infraAvailability" value="99" min="90" max="100" step="1" disabled aria-disabled="true">
          </div>
          <p class="help-text">Låst visning for Nodes. Beregningen bruker batterikonfigurasjon i bakgrunnen.</p>
        </div>
      </section>

      <!-- FCR-N data config -->
      <div data-tab-config="fcr" style="display: none;">
        <section class="config-section collapsible open">
          <button class="collapsible-toggle" type="button"><h2>Datavalg</h2></button>
          <div class="collapsible-body">
            <div class="input-group">
              <label for="year">År <button class="info-btn" data-help="year">?</button></label>
              <select id="year"></select>
              <div class="help-text" id="help-year">Hvilket år prisdata skal hentes fra. Prisene varierer fra år til år.</div>
            </div>
          </div>
        </section>

        <input type="hidden" id="simHours" value="8760">
        <input type="hidden" name="profile" value="medium">
        <input type="hidden" id="seed" value="42">

        <button id="calculateBtn" class="btn btn-primary">Beregn inntekt</button>
      </div>

      <div data-tab-config="afrr" style="display: none;">
        <section class="config-section collapsible open">
          <button class="collapsible-toggle" type="button"><h2>aFRR-parametere</h2></button>
          <div class="collapsible-body">
            <div class="input-group">
              <label for="afrrYear">aFRR år</label>
              <select id="afrrYear"></select>
            </div>

          </div>
        </section>
        <button id="calculateAfrrBtn" class="btn btn-primary" type="button">Beregn aFRR</button>
      </div>

      <div data-tab-config="nodes" style="display: none;">
        <section class="config-section collapsible open">
          <button class="collapsible-toggle" type="button"><h2>Nodetender</h2></button>
          <div class="collapsible-body">
            <div class="input-group">
              <label for="nodesTender">Tender</label>
              <select id="nodesTender"></select>
            </div>
          </div>
        </section>
        <button id="calculateNodesBtn" class="btn btn-primary" type="button">Beregn inntekt</button>
      </div>

      <div data-tab-config="combined" style="display: none;">
        <section class="config-section collapsible open">
          <button class="collapsible-toggle" type="button"><h2>Hvordan marked velges</h2></button>
          <div class="collapsible-body">
            <p class="info-text">Vi prioriterer markedet med høyest forventet verdi per MW i aktuell time.</p>
          </div>
        </section>

        <section class="config-section collapsible open">
          <button class="collapsible-toggle" type="button"><h2>Hvorfor tall varierer per marked</h2></button>
          <div class="collapsible-body">
            <p class="info-text">Markedsinntekter kan flytte seg mellom aFRR/FCR-N/Nodes, men totalen holdes konservativ.</p>
          </div>
        </section>

        <section class="config-section collapsible open">
          <button class="collapsible-toggle" type="button"><h2>Vanlige spørsmål</h2></button>
          <div class="collapsible-body">
            <p class="info-text"><strong>Kan dere delta i flere markeder?</strong><br>Ja, men ikke med samme kapasitet samtidig.</p>
            <p class="info-text"><strong>Hvorfor lavere FCR-N i kombinert modell?</strong><br>Fordi kapasitet også allokeres til aFRR/Nodes når det gir høyere verdi.</p>
          </div>
        </section>
      </div>

      <div data-tab-config="yearlyCombined">
        <section class="config-section collapsible open">
          <button class="collapsible-toggle" type="button"><h2>Årskalkyle</h2></button>
          <div class="collapsible-body">
            <div class="input-group">
              <label for="yearlyCombinedYear">År for kalkyle</label>
              <select id="yearlyCombinedYear"></select>
            </div>
          </div>
        </section>
        <button id="calculateYearlyCombinedBtn" class="btn btn-primary" type="button">Beregn årlig total</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <section class="hero-banner">
        <div class="hero-content">
          <p class="hero-kicker">Hydropower</p>
          <h2 id="heroTitle">Årskalkyle</h2>
          <p id="heroDescription">Kombinerer FCR-N, aFRR og Nodes i én årlig inntektskalkyle med samme metoder som i hver enkelt modul.</p>
        </div>
      </section>

      <!-- FCR-N Tab Content -->
      <div id="fcrContent" class="tab-content" data-tab-panel="fcr" role="tabpanel" aria-labelledby="tab-fcr">
      <div id="loadingState" class="loading-state">
        <p>Laster prisdata...</p>
      </div>

      <div class="market-context-box market-context-battery">
        <p>Dette gjelder batteriet.</p>
      </div>

      <div id="resultsContainer" style="display: none;">
        <!-- Status message -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Metrics -->
        <div class="metrics-row">
          <div class="metric-card">
            <span class="metric-value" id="totalRevenue">-</span>
            <span class="metric-label">Total inntekt <button class="info-btn" data-help="totalRevenue">?</button></span>
            <div class="help-text" id="help-totalRevenue">Summen batteriet tjener på et helt år ved å delta i frekvensmarkedet (FCR-N).</div>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="availableHours">-</span>
            <span class="metric-label">Tilgjengelige timer <button class="info-btn" data-help="availableHours">?</button></span>
            <div class="help-text" id="help-availableHours">Antall timer batteriet kan levere tjenesten. Noen timer er utilgjengelige fordi batteriet er for fullt eller for tomt.</div>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="availability">-</span>
            <span class="metric-label">Tilgjengelighet <button class="info-btn" data-help="availability">?</button></span>
            <div class="help-text" id="help-availability">Prosent av tiden batteriet kan delta i markedet. 95% betyr at det fungerer 95% av tiden.</div>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="avgPrice">-</span>
            <span class="metric-label">Snittpris <button class="info-btn" data-help="avgPrice">?</button></span>
            <div class="help-text" id="help-avgPrice">Gjennomsnittlig pris per MW per time i markedet dette året.</div>
          </div>
        </div>

        <p id="annualizedNote" class="annualized-note" style="display: none;"></p>

        <!-- Charts -->
        <section class="chart-section">
          <h2>Månedlig inntekt <button class="info-btn" data-help="monthlyChart">?</button></h2>
          <div class="help-text" id="help-monthlyChart">Viser hvor mye batteriet tjener hver måned. Prisene er ofte høyere om vinteren.</div>
          <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
          </div>
        </section>

        <section class="chart-section">
          <h2>Prisfordeling <button class="info-btn" data-help="priceChart">?</button></h2>
          <div class="help-text" id="help-priceChart">Viser hvor ofte ulike prisnivåer forekommer. Høye søyler = vanlige priser.</div>
          <div class="chart-container">
            <canvas id="priceChart"></canvas>
          </div>
        </section>

        <section id="socSection" class="chart-section" style="display: none;">
          <h2>SOC-utvikling <button class="info-btn" data-help="socChart">?</button></h2>
          <div class="help-text" id="help-socChart">Viser hvordan batteriets ladenivå endrer seg gjennom året. De røde stiplede linjene viser grensene dine.</div>
          <div class="chart-container chart-container-wide">
            <canvas id="socChart"></canvas>
          </div>
        </section>

        <section id="freqSection" class="chart-section" style="display: none;">
          <h2>Frekvensfordeling <button class="info-btn" data-help="freqChart">?</button></h2>
          <div class="help-text" id="help-freqChart">Viser hvor ofte strømnettet har ulike frekvenser. Grønne søyler = normalt (49.9-50.1 Hz), røde = unormalt.</div>
          <div class="chart-container">
            <canvas id="freqChart"></canvas>
          </div>
        </section>

        <!-- Export -->
        <section class="export-section">
          <button id="exportPdfBtn" class="btn btn-accent">Eksporter PDF</button>
          <button id="exportBtn" class="btn btn-secondary">Eksporter CSV</button>
        </section>

        <!-- Summary Table -->
        <section class="summary-section">
          <h2>Månedlig oppsummering</h2>
          <div class="table-container">
            <table id="summaryTable">
              <thead>
                <tr>
                  <th>Måned</th>
                  <th>Inntekt (EUR)</th>
                  <th>Timer</th>
                  <th>Snittpris (EUR/MW)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
      </div><!-- /fcrContent -->

      <div id="afrrContent" class="tab-content" data-tab-panel="afrr" role="tabpanel" aria-labelledby="tab-afrr">
        <div class="market-context-box market-context-solar">
          <p>Dette gjelder solkraftverket.</p>
        </div>
        <div id="afrrStatusMessage" class="status-message info">Laster aFRR-data...</div>

        <div class="metrics-row">
          <div class="metric-card">
            <span class="metric-value" id="afrrRevenue">-</span>
            <span class="metric-label">aFRR-inntekt</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="afrrBidHours">-</span>
            <span class="metric-label">Budtimer</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="afrrAvgPrice">-</span>
            <span class="metric-label">Snitt aFRR-pris</span>
          </div>
        </div>

        <section class="chart-section">
          <h2>Månedlig aFRR-inntekt</h2>
          <div class="chart-container">
            <canvas id="afrrMonthlyChart"></canvas>
          </div>
        </section>


        <section class="export-section">
          <button id="afrrExportCsvBtn" class="btn btn-secondary">Eksporter CSV</button>
        </section>

        <section class="summary-section">
          <h2>Månedlig oppsummering</h2>
          <div class="table-container">
            <table id="afrrSummaryTable">
              <thead>
                <tr>
                  <th>Måned</th>
                  <th>aFRR-inntekt (EUR)</th>
                  <th>Budtimer</th>
                  <th>Snitt aFRR-pris (EUR/MW)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <div id="nodesContent" class="tab-content" data-tab-panel="nodes" role="tabpanel" aria-labelledby="tab-nodes">
        <div class="market-context-box market-context-infra">
          <p>Dette gjelder lokal infrastruktur i Vikersund, som vi jobber tett med nå for å realisere. Derfor er Nodes valgfritt i totalberegningen.</p>
        </div>
        <div id="nodesStatusMessage" class="status-message info">Laster tendere...</div>

        <section class="nodes-tender-overview">
          <h2>Valgt tender, enkelt forklart</h2>
          <p id="nodesTenderSummary" class="nodes-tender-summary">Velg en tender for å se hva den betyr i praksis.</p>
          <div class="nodes-tender-grid">
            <article class="nodes-tender-card">
              <span class="nodes-tender-label">Tender</span>
              <span id="nodesTenderName" class="nodes-tender-value">-</span>
            </article>
            <article class="nodes-tender-card">
              <span class="nodes-tender-label">Marked / node</span>
              <span id="nodesTenderMarket" class="nodes-tender-value">-</span>
            </article>
            <article class="nodes-tender-card">
              <span class="nodes-tender-label">Periode</span>
              <span id="nodesTenderPeriod" class="nodes-tender-value">-</span>
            </article>
            <article class="nodes-tender-card">
              <span class="nodes-tender-label">Aktiv tid</span>
              <span id="nodesTenderSchedule" class="nodes-tender-value">-</span>
            </article>
            <article class="nodes-tender-card">
              <span class="nodes-tender-label">Pris</span>
              <span id="nodesTenderPrice" class="nodes-tender-value">-</span>
            </article>
            <article class="nodes-tender-card">
              <span class="nodes-tender-label">Volum</span>
              <span id="nodesTenderVolume" class="nodes-tender-value">-</span>
            </article>
            <article class="nodes-tender-card">
              <span class="nodes-tender-label">Timer i perioden</span>
              <span id="nodesTenderHours" class="nodes-tender-value">-</span>
            </article>
          </div>
        </section>

        <div class="metrics-row">
          <div class="metric-card">
            <span class="metric-value" id="nodesTotalIncome">-</span>
            <span class="metric-label">Total inntekt (NOK)</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="nodesEligibleHours">-</span>
            <span class="metric-label">Kvalifiserte timer</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="nodesPriceNokMwH">-</span>
            <span class="metric-label">Pris (NOK/MWh)</span>
          </div>
        </div>

        <section class="export-section">
          <button id="nodesExportCsvBtn" class="btn btn-secondary">Eksporter CSV</button>
        </section>

        <section class="summary-section">
          <h2>Månedlig oppsummering</h2>
          <div class="table-container" id="nodesTableContainer" data-state="loading">
            <table id="nodesTable">
              <thead>
                <tr>
                  <th>Måned</th>
                  <th>Kvalifiserte timer</th>
                  <th>Inntekt (NOK)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="visual-state">Laster tendere...</div>
          </div>
        </section>
      </div>

      <div id="combinedContent" class="tab-content" data-tab-panel="combined" role="tabpanel" aria-labelledby="tab-combined">
        <section class="module-panel combined-panel">
          <p class="module-pill">Kombinert modell</p>
          <h3>Markedsvalg per time</h3>
          <p class="module-intro">
            Kapasitet kan flyttes mellom aFRR, FCR-N og NODES/Euroflex gjennom året.
            Enkeltmarkedene kan variere, men samlet reserveinntekt er konservativt estimert til minst €267 882.
          </p>

          <div class="combined-inner-tabs-wrap">
            <div class="combined-inner-tabs" role="tablist" aria-label="Kombinert visning">
              <button
                class="combined-inner-tab-btn active"
                type="button"
                data-combined-tab="overview"
                role="tab"
                aria-selected="true"
                aria-controls="combinedTabOverview"
              >Forklaring</button>
              <button
                class="combined-inner-tab-btn"
                type="button"
                data-combined-tab="ratio"
                role="tab"
                aria-selected="false"
                aria-controls="combinedTabRatio"
              >Ratio-simulator</button>
            </div>
          </div>

          <section
            id="combinedTabOverview"
            class="combined-inner-panel active"
            data-combined-panel="overview"
            role="tabpanel"
            aria-hidden="false"
          >
            <section class="combined-qa-grid">
              <article class="module-card combined-answer">
                <h4>FCR-N og NODES/Euroflex samtidig?</h4>
                <p>
                  Ja i løpet av året, men ikke med samme kapasitet i samme time.
                  Allokeringen gjøres time for time.
                </p>
              </article>
              <article class="module-card combined-answer">
                <h4>aFRR og FCR-N samtidig?</h4>
                <p>
                  Prinsippet er det samme. Reservert kapasitet kan ikke dobbelbookes.
                  Markedet med best verdi i aktuell time prioriteres.
                </p>
              </article>
            </section>

            <div class="metrics-row combined-metrics">
              <div class="metric-card">
                <span class="metric-value" id="combinedReserveTotal">-</span>
                <span class="metric-label">Konservativ minimumssum</span>
              </div>
              <div class="metric-card">
                <span class="metric-value" id="combinedAfrrRevenue">-</span>
                <span class="metric-label">aFRR</span>
              </div>
              <div class="metric-card">
                <span class="metric-value" id="combinedFcrRevenue">-</span>
                <span class="metric-label">FCR-N i kombinert</span>
              </div>
              <div class="metric-card">
                <span class="metric-value" id="combinedNodesRevenue">-</span>
                <span class="metric-label">NODES/Euroflex</span>
              </div>
            </div>

            <section class="combined-insight-grid">
              <article class="module-card">
                <h4>Hvorfor er FCR-N €52 000 her, men €165 000 i eget ark?</h4>
                <p>
                  €165 000 er et separat FCR-N-estimat med større allokering til FCR-N.
                  I kombinert drift prioriteres marked med høyest verdi time for time, og FCR-N-andelen blir lavere.
                </p>
                <p class="combined-diff" id="combinedDifferenceText">Differanse: -</p>
              </article>
              <article class="module-card">
                <h4>Allokeringsregel</h4>
                <p>
                  For hver time velges markedet med høyest forventet verdi gitt tilgjengelig kapasitet og markedskrav.
                  Fordelingen kan variere mellom markedene, mens totalen er satt konservativt.
                </p>
              </article>
            </section>

            <section class="chart-section">
              <h2>Eksempeluke: valgt marked per timeblokk</h2>
              <div class="chart-container">
                <canvas id="combinedPriorityChart"></canvas>
              </div>
            </section>

            <section class="summary-section">
              <h2>Eksempel på allokering</h2>
              <div class="table-container">
                <table id="combinedPriorityTable">
                  <thead>
                    <tr>
                      <th>Timeblokk</th>
                      <th>Valgt marked</th>
                      <th>Hvorfor</th>
                      <th>Konsekvens</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </section>
          </section>

          <section
            id="combinedTabRatio"
            class="combined-inner-panel"
            data-combined-panel="ratio"
            role="tabpanel"
            aria-hidden="true"
          >
            <div class="module-card combined-slider-card">
              <h4>Fast totalsum, variabel fordeling</h4>
              <p class="combined-slider-lead">
                Flytt slideren for å endre ratio mellom markedene. Totalen holdes konstant.
              </p>
              <label for="combinedAfrrShare">aFRR-andel: <span id="combinedAfrrShareValue">-</span></label>
              <input type="range" id="combinedAfrrShare" min="10" max="95" step="1">
              <p class="combined-slider-note">Resterende andel fordeles mellom FCR-N og NODES/Euroflex i samme forhold som grunnscenariet.</p>
            </div>

            <div class="metrics-row combined-metrics combined-ratio-metrics">
              <div class="metric-card">
                <span class="metric-value" id="combinedRatioTotal">-</span>
                <span class="metric-label">Total (fast)</span>
              </div>
              <div class="metric-card">
                <span class="metric-value" id="combinedRatioAfrr">-</span>
                <span class="metric-label">aFRR</span>
              </div>
              <div class="metric-card">
                <span class="metric-value" id="combinedRatioFcr">-</span>
                <span class="metric-label">FCR-N</span>
              </div>
              <div class="metric-card">
                <span class="metric-value" id="combinedRatioNodes">-</span>
                <span class="metric-label">NODES/Euroflex</span>
              </div>
            </div>

            <section class="chart-section">
              <h2>Dynamisk fordeling</h2>
              <div class="chart-container">
                <canvas id="combinedRatioChart"></canvas>
              </div>
            </section>
          </section>
        </section>
      </div>

      <div id="yearlyCombinedContent" class="tab-content active" data-tab-panel="yearlyCombined" role="tabpanel" aria-labelledby="tab-yearlyCombined">
        <div id="yearlyCombinedStatusMessage" class="status-message info">Trykk "Beregn årlig total".</div>

        <section class="module-panel yearly-combined-panel">
          <p class="module-pill">Årlig kalkyle</p>
          <h3>FCR-N + aFRR + Nodes</h3>
          <p id="yearlyCombinedMeta" class="module-intro">Klar for beregning.</p>

          <div class="metrics-row yearly-combined-metrics">
            <div class="metric-card">
              <span class="metric-value" id="yearlyCombinedTotalEur">-</span>
              <span class="metric-label">Total (EUR)</span>
            </div>
            <div class="metric-card">
              <span class="metric-value" id="yearlyCombinedFcrEur">-</span>
              <span class="metric-label">FCR-N (EUR)</span>
            </div>
            <div class="metric-card">
              <span class="metric-value" id="yearlyCombinedAfrrEur">-</span>
              <span class="metric-label">aFRR (EUR)</span>
            </div>
            <div class="metric-card yearly-nodes-col" id="yearlyCombinedNodesCard">
              <span class="metric-value" id="yearlyCombinedNodesEur">-</span>
              <span class="metric-label">Nodes (opsjonell, EUR)</span>
            </div>
          </div>

          <section class="chart-section">
            <h2>Månedlig fordeling (EUR)</h2>
            <div class="chart-container">
              <canvas id="yearlyCombinedMonthlyChart"></canvas>
            </div>
          </section>

          <section class="export-section">
            <button id="yearlyCombinedExportCsvBtn" class="btn btn-secondary" type="button">Eksporter CSV</button>
          </section>

          <section class="summary-section">
            <h2>Månedlig oppsummering</h2>
            <div class="table-container">
              <table id="yearlyCombinedSummaryTable">
                <thead>
                  <tr>
                    <th>Måned</th>
                    <th>FCR-N (EUR)</th>
                    <th>aFRR (EUR)</th>
                    <th class="yearly-nodes-col">Nodes (opsjonell, EUR)</th>
                    <th>Total (EUR)</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </section>
        </section>
      </div>
    </main>
  </div>

  <div id="popover" class="popover"></div>
  <script type="module" src="./app.ts"></script>
</body>
</html>
