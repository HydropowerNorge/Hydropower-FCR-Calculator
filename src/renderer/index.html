<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; worker-src 'self' blob:; style-src 'self' 'unsafe-inline'; connect-src 'self' ws: wss:">
  <title>Hydropower</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="brand-lockup">
          <img class="brand-logo" src="assets/hydropower-logo.png" alt="Hydropower logo">
          <div class="brand-copy">
            <p class="brand-eyebrow">Hydropower Energy Platform</p>
            <h1>Hydropower</h1>
          </div>
        </div>
      </div>

      <nav class="tab-nav" role="tablist" aria-label="Analysemoduler">
        <button
          id="tab-fcr"
          class="tab-btn active"
          data-tab="fcr"
          role="tab"
          aria-controls="fcrContent"
          aria-selected="true"
          data-hero-title="FCR-N analyse"
          data-hero-description="Bruk historiske NO1-data til å estimere batteriinntekter med tydelige KPI-er og eksportklare rapporter."
        >FCR-N</button>
        <button
          id="tab-afrr"
          class="tab-btn"
          data-tab="afrr"
          role="tab"
          aria-controls="afrrContent"
          aria-selected="false"
          data-hero-title="aFRR"
          data-hero-description="Årlig aFRR down-simulering for sol med kapasitetsbetaling, aktivering og curtailmentkost."
        >aFRR</button>
        <button
          id="tab-nodes"
          class="tab-btn"
          data-tab="nodes"
          role="tab"
          aria-controls="nodesContent"
          aria-selected="false"
          data-hero-title="Nodes"
          data-hero-description="Planlagt nodenivå-visning for lokasjon, begrensninger og ytelsesoversikt."
        >Nodes</button>
        <button
          id="tab-combined"
          class="tab-btn"
          data-tab="combined"
          role="tab"
          aria-controls="combinedContent"
          aria-selected="false"
          data-hero-title="Kombinert"
          data-hero-description="Planlagt samlekjøring av markeder for helhetlig verdiestimat og sammenligning."
        >Kombinert</button>
      </nav>

      <section class="config-section">
        <h2>Batterikonfigurasjon</h2>

        <div class="input-group">
          <label for="powerMw">Effektkapasitet (MW) <button class="info-btn" data-help="powerMw">?</button></label>
          <input type="number" id="powerMw" value="1.0" min="0.1" max="100" step="0.1">
          <div class="help-text" id="help-powerMw">Hvor mye strøm batteriet kan levere på én gang. Eksempel: 1 MW = nok strøm til 500-1000 boliger samtidig.</div>
        </div>

        <div class="input-group">
          <label for="capacityMwh">Energikapasitet (MWh) <button class="info-btn" data-help="capacityMwh">?</button></label>
          <input type="number" id="capacityMwh" value="2.0" min="0.1" max="500" step="0.1">
          <div class="help-text" id="help-capacityMwh">Hvor mye strøm batteriet kan lagre totalt. Eksempel: 2 MWh = nok til å drive 1 MW i 2 timer.</div>
        </div>

        <div class="input-group">
          <label for="efficiency">Virkningsgrad: <span id="efficiencyValue">90</span>% <button class="info-btn" data-help="efficiency">?</button></label>
          <input type="range" id="efficiency" value="90" min="70" max="99">
          <div class="help-text" id="help-efficiency">Hvor mye strøm du får tilbake når du lader og bruker batteriet. 90% betyr at 10% går tapt som varme.</div>
        </div>

        <div class="input-group">
          <label for="socMin">Minimum SOC: <span id="socMinValue">20</span>% <button class="info-btn" data-help="socMin">?</button></label>
          <input type="range" id="socMin" value="20" min="0" max="50">
          <div class="help-text" id="help-socMin">Laveste tillatte ladenivå. 20% betyr at batteriet aldri tømmes helt - det forlenger levetiden.</div>
        </div>

        <div class="input-group">
          <label for="socMax">Maksimum SOC: <span id="socMaxValue">80</span>% <button class="info-btn" data-help="socMax">?</button></label>
          <input type="range" id="socMax" value="80" min="50" max="100">
          <div class="help-text" id="help-socMax">Høyeste tillatte ladenivå. 80% betyr at batteriet aldri lades helt fullt - det forlenger levetiden.</div>
        </div>
      </section>

      <!-- FCR-N data config -->
      <div data-tab-config="fcr">
        <section class="config-section">
          <h2>Datavalg</h2>

          <div class="input-group">
            <label for="year">År <button class="info-btn" data-help="year">?</button></label>
            <select id="year"></select>
            <div class="help-text" id="help-year">Hvilket år prisdata skal hentes fra. Prisene varierer fra år til år.</div>
          </div>
        </section>

        <input type="hidden" id="simHours" value="8760">
        <input type="hidden" name="profile" value="medium">
        <input type="hidden" id="seed" value="42">

        <button id="calculateBtn" class="btn btn-primary">Beregn inntekt</button>
      </div>

      <div data-tab-config="afrr" style="display: none;">
        <section class="config-section">
          <h2>aFRR-parametere</h2>

          <div class="input-group">
            <label for="afrrYear">aFRR år</label>
            <select id="afrrYear"></select>
          </div>

          <div class="input-group">
            <label for="afrrSolarYear">Solprofil år (60m)</label>
            <select id="afrrSolarYear"></select>
          </div>

          <div class="input-group">
            <label for="afrrEurToNok">EUR → NOK</label>
            <input type="number" id="afrrEurToNok" value="11" min="1" max="30" step="0.1">
          </div>

          <div class="input-group">
            <label for="afrrMinBidMw">Min budstørrelse (MW)</label>
            <input type="number" id="afrrMinBidMw" value="1" min="1" max="50" step="1">
          </div>

          <div class="input-group">
            <label for="afrrActivationMaxPct">Maks aktivering (%)</label>
            <input type="number" id="afrrActivationMaxPct" value="100" min="1" max="100" step="1">
          </div>

          <div class="input-group">
            <label for="afrrSeed">Tilfeldig seed</label>
            <input type="number" id="afrrSeed" value="42" min="1" max="999999" step="1">
          </div>

          <p id="afrrDataStatus" class="info-text"></p>
        </section>
        <button id="calculateAfrrBtn" class="btn btn-primary" type="button">Beregn aFRR</button>
      </div>

      <div data-tab-config="nodes" style="display: none;">
        <section class="config-section config-section-compact">
          <h2>Nodedata</h2>
          <div class="input-group">
            <label for="nodesDataset">Datasett</label>
            <select id="nodesDataset">
              <option value="nodes_2026_pilot">Pilot 2026</option>
            </select>
          </div>

          <div class="input-group">
            <label for="nodesGridNode">Grid node</label>
            <select id="nodesGridNode">
              <option value="">Alle</option>
            </select>
          </div>

          <div class="input-group">
            <label for="nodesMarket">Marked</label>
            <select id="nodesMarket">
              <option value="">Alle</option>
            </select>
          </div>

          <p id="nodesFilterInfo" class="info-text">Laster nodedata...</p>
        </section>
        <button id="refreshNodesBtn" class="btn btn-secondary" type="button">Oppdater nodedata</button>
      </div>

      <div data-tab-config="combined" style="display: none;">
        <section class="config-section config-section-compact">
          <h2>Kombinert</h2>
          <p class="info-text">Denne modulen er under utvikling. Her kommer kombinert analyse på tvers av markedene.</p>
        </section>
        <button class="btn btn-secondary" type="button" disabled>Kommer snart</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <section class="hero-banner">
        <div class="hero-content">
          <p class="hero-kicker">Hydropower</p>
          <h2 id="heroTitle">FCR-N analyse</h2>
          <p id="heroDescription">Bruk historiske NO1-data til å estimere batteriinntekter med tydelige KPI-er og eksportklare rapporter.</p>
        </div>
      </section>

      <!-- FCR-N Tab Content -->
      <div id="fcrContent" class="tab-content active" data-tab-panel="fcr" role="tabpanel" aria-labelledby="tab-fcr">
      <div id="loadingState" class="loading-state">
        <p>Laster prisdata...</p>
      </div>

      <div id="resultsContainer" style="display: none;">
        <!-- Status message -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Metrics -->
        <div class="metrics-row">
          <div class="metric-card">
            <span class="metric-value" id="totalRevenue">-</span>
            <span class="metric-label">Total inntekt <button class="info-btn" data-help="totalRevenue">?</button></span>
            <div class="help-text" id="help-totalRevenue">Summen batteriet tjener på et helt år ved å delta i frekvensmarkedet (FCR-N).</div>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="availableHours">-</span>
            <span class="metric-label">Tilgjengelige timer <button class="info-btn" data-help="availableHours">?</button></span>
            <div class="help-text" id="help-availableHours">Antall timer batteriet kan levere tjenesten. Noen timer er utilgjengelige fordi batteriet er for fullt eller for tomt.</div>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="availability">-</span>
            <span class="metric-label">Tilgjengelighet <button class="info-btn" data-help="availability">?</button></span>
            <div class="help-text" id="help-availability">Prosent av tiden batteriet kan delta i markedet. 95% betyr at det fungerer 95% av tiden.</div>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="avgPrice">-</span>
            <span class="metric-label">Snittpris <button class="info-btn" data-help="avgPrice">?</button></span>
            <div class="help-text" id="help-avgPrice">Gjennomsnittlig pris per MW per time i markedet dette året.</div>
          </div>
        </div>

        <p id="annualizedNote" class="annualized-note" style="display: none;"></p>

        <!-- Charts -->
        <section class="chart-section">
          <h2>Månedlig inntekt <button class="info-btn" data-help="monthlyChart">?</button></h2>
          <div class="help-text" id="help-monthlyChart">Viser hvor mye batteriet tjener hver måned. Prisene er ofte høyere om vinteren.</div>
          <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
          </div>
        </section>

        <section class="chart-section">
          <h2>Prisfordeling <button class="info-btn" data-help="priceChart">?</button></h2>
          <div class="help-text" id="help-priceChart">Viser hvor ofte ulike prisnivåer forekommer. Høye søyler = vanlige priser.</div>
          <div class="chart-container">
            <canvas id="priceChart"></canvas>
          </div>
        </section>

        <section id="socSection" class="chart-section" style="display: none;">
          <h2>SOC-utvikling <button class="info-btn" data-help="socChart">?</button></h2>
          <div class="help-text" id="help-socChart">Viser hvordan batteriets ladenivå endrer seg gjennom året. De røde stiplede linjene viser grensene dine.</div>
          <div class="chart-container chart-container-wide">
            <canvas id="socChart"></canvas>
          </div>
        </section>

        <section id="freqSection" class="chart-section" style="display: none;">
          <h2>Frekvensfordeling <button class="info-btn" data-help="freqChart">?</button></h2>
          <div class="help-text" id="help-freqChart">Viser hvor ofte strømnettet har ulike frekvenser. Grønne søyler = normalt (49.9-50.1 Hz), røde = unormalt.</div>
          <div class="chart-container">
            <canvas id="freqChart"></canvas>
          </div>
        </section>

        <!-- Export -->
        <section class="export-section">
          <button id="exportPdfBtn" class="btn btn-accent">Eksporter PDF</button>
          <button id="exportBtn" class="btn btn-secondary">Eksporter CSV</button>
          <button id="exportXlsxBtn" class="btn btn-secondary">Eksporter Excel</button>
        </section>

        <!-- Summary Table -->
        <section class="summary-section">
          <h2>Månedlig oppsummering</h2>
          <div class="table-container">
            <table id="summaryTable">
              <thead>
                <tr>
                  <th>Måned</th>
                  <th>Inntekt (EUR)</th>
                  <th>Timer</th>
                  <th>Snittpris (EUR/MW)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
      </div><!-- /fcrContent -->

      <div id="afrrContent" class="tab-content" data-tab-panel="afrr" role="tabpanel" aria-labelledby="tab-afrr">
        <div id="afrrStatusMessage" class="status-message info">Laster aFRR-data...</div>

        <div class="metrics-row">
          <div class="metric-card">
            <span class="metric-value" id="afrrTotalRevenue">-</span>
            <span class="metric-label">Total inntekt</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="afrrAfrrRevenue">-</span>
            <span class="metric-label">aFRR netto</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="afrrBidHours">-</span>
            <span class="metric-label">Budtimer</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="afrrAvgPrice">-</span>
            <span class="metric-label">Snitt aFRR-pris</span>
          </div>
        </div>

        <section class="chart-section">
          <h2>Månedlig totalinntekt</h2>
          <div class="chart-container">
            <canvas id="afrrMonthlyChart"></canvas>
          </div>
        </section>

        <section class="chart-section">
          <h2>Aktiveringsfordeling</h2>
          <div class="chart-container">
            <canvas id="afrrActivationChart"></canvas>
          </div>
        </section>

        <section class="chart-section">
          <h2>Kumulativ inntekt</h2>
          <div class="chart-container">
            <canvas id="afrrCumulativeChart"></canvas>
          </div>
        </section>

        <section class="export-section">
          <button id="afrrExportCsvBtn" class="btn btn-secondary">Eksporter CSV</button>
        </section>

        <section class="summary-section">
          <h2>Månedlig oppsummering</h2>
          <div class="table-container">
            <table id="afrrSummaryTable">
              <thead>
                <tr>
                  <th>Måned</th>
                  <th>Total (NOK)</th>
                  <th>aFRR netto (NOK)</th>
                  <th>Budtimer</th>
                  <th>Snitt aFRR-pris (NOK/MW)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <div id="nodesContent" class="tab-content" data-tab-panel="nodes" role="tabpanel" aria-labelledby="tab-nodes">
        <div id="nodesStatusMessage" class="status-message info">Laster nodedata...</div>

        <div class="metrics-row">
          <div class="metric-card">
            <span class="metric-value" id="nodesTenderCount">-</span>
            <span class="metric-label">Tenderer</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="nodesTotalMw">-</span>
            <span class="metric-label">Samlet MW</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="nodesAvgReservation">-</span>
            <span class="metric-label">Reservasjon</span>
          </div>
          <div class="metric-card">
            <span class="metric-value" id="nodesAvgActivation">-</span>
            <span class="metric-label">Aktivering</span>
          </div>
        </div>

        <section class="summary-section">
          <h2>Nodetenderer</h2>
          <div class="table-container" id="nodesTableContainer" data-state="loading">
            <table id="nodesTable">
              <thead>
                <tr>
                  <th>Navn</th>
                  <th>Status</th>
                  <th>Node</th>
                  <th>Marked</th>
                  <th>Periode</th>
                  <th>Vindu</th>
                  <th>Pris</th>
                  <th>MW</th>
                </tr>
              </thead>
              <tbody id="nodesTableBody"></tbody>
            </table>
            <div class="visual-state">Laster nodedata...</div>
          </div>
        </section>
      </div>

      <div id="combinedContent" class="tab-content" data-tab-panel="combined" role="tabpanel" aria-labelledby="tab-combined">
        <section class="module-panel">
          <p class="module-pill">Planlagt modul</p>
          <h3>Kombinert</h3>
          <p class="module-intro">Denne fanen samler FCR-N, arbitrasje og kommende markeder i ett scenario med felles resultater.</p>
          <div class="module-grid">
            <article class="module-card">
              <h4>Scenariokjøring</h4>
              <p>Kjør markeder side om side uten å endre grunnkonfigurasjon.</p>
            </article>
            <article class="module-card">
              <h4>Prioriteringsregler</h4>
              <p>Definer hvilke markeder som får kapasitet ved konflikt.</p>
            </article>
            <article class="module-card">
              <h4>Samlet verdi</h4>
              <p>En konsolidert KPI-visning med eksport for ledelse og drift.</p>
            </article>
          </div>
        </section>
      </div>
    </main>
  </div>

  <div id="popover" class="popover"></div>
  <script type="module" src="./app.ts"></script>
</body>
</html>
